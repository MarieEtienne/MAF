---
title: "TD1 - Analyse en composante Principale"
author:
  - name: MAF 2025-2026
    affiliation:
      - ENSAI - CREST
    email: marie-pierre.etienne@ensai.fr
institute: https://marieetienne.github.io/MAF/
bibliography: TPs.bib
execute:
  freeze: auto
format: pdf
---

```{r setup, include=FALSE, eval = TRUE, message = FALSE}
library(tidyverse)
library(FactoMineR)
knitr::opts_chunk$set(echo = FALSE, comment = NA,  message = FALSE,
                      warning = FALSE, eval = FALSE,
                      fig.align = "center")
theme_set(theme_minimal())
options(ggplot2.discrete.colour=   scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) )
couleur <-  wesanderson::wes_palette(name = "Darjeeling1")
scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / ( sqrt((length(x)-1) / length(x)) *sd(x, na.rm) )

```

::: hidden
\newcommand\R{{\mathbb{R}}}
\newcommand\Xbf{{\boldsymbol{X}}}
\newcommand\norm[1]{\lVert#1\rVert}
\newcommand\xcol[1]{\boldsymbol{x}^{#1}}
\newcommand\xrow[1]{\boldsymbol{x}_{#1}}
\newcommand\xbf{\boldsymbol{x}}
\newcommand\ybf{\boldsymbol{y}}
:::

# Avant-propos

Les TD et TP du cours MAF servent trois objectifs:

-   Revenir sur certaines notions de cours pour mieux les appréhender

-   donner des outils pratiques pour mettre en oeuvre les méthodes vues
    en cours,

-   réfléchir à leur mise en oeuvre et leur application dans des cas
    concrets.

Il est donc fréquent que l'on fasse certaine partie avec peu d'outils (à
la main) pouur bien faire le lien avec les concets de cours, tandis que
d'autres servent d'exemple pour illustrer comment dérouler une analyse
sur un jeu de données en particulier.

# Faire le lien avec le cours

On s'intéresse à un jeu de données de 100 individus, pour lesquels on
mesure 4 variables

```{r}
#| label: donnees_marche
#| echo: false
#| eval: true
#| message: false

walking_dta <- read.table('walking_dataset_100.csv', sep = ',', header = TRUE, row.names = 1)
```

-   le poids en $Kg$ (variable `P` )
-   la taille en $m$,
-   la longueur de pas en $cm$,
-   la vitesse de marche en $m.s^{-1}$.

```{r}
#| label: donnees_marche_sum
#| echo: false
#| eval: true
#| message: false

n <- nrow(walking_dta)
sum_dta <- walking_dta |>
  summarize_all(list(moyenne = mean, variance = var))  |>
  pivot_longer(
    everything(),
    names_to = c("variable", ".value"),
    names_sep = "_"
  ) |>
   mutate(variance = variance *(n-1)/n)
sum_dta |>
  mutate(across(is.numeric, \(x) round(x, 2)))
```

1.  Que peut-on dire de la dispersion le long de chacun des axes
    initiaux.

2.  Combien vaut l'inertie projeté sur l'axe de vecteur directeur
    $(1,0,0,0)^\top$ ?


```{r}
sum_dta |>
  mutate(across(is.numeric, \(x) round(x, 2))) |> summarise(Inertie = round(sum(variance)))
```

3.  Combien vaut l'inertie projeté sur l'axe de vecteur directeur
    $(0,1,0,0)^\top$ ?



On note $X$ de dimension $100 \times 4$ la matrice des données centrées.
Chaque individu a le même poids.

4.  On souhaite utiliser la distance euclidienne puis réaliser une ACP.
    le cours indique qu'on diagonalise la matrice $MVM$. Indiquer ce que
    sont les matrices $V$ et $M$ impliquées.

```{r}
#| label: donnees_marche_XX
#| echo: false
#| eval: true
#| message: false

X <- scale(walking_dta, center = TRUE, scale =FALSE) |> as.matrix()
V <- 1/n * t(X) %*% X
```

5.  On diagonalise la matrice $MVM$ et on obtient les valeurs propres
    suivantes. Quelle est l'inertie portée par le premier plan
    principal, quel pourcentage de l'inertie totale ceci représente-t-il
    ? Pensez vous qu'on ait ainsi une bonne manière de représenter les
    données inditiales en seulement deux dimensions ?

```{r}
#| label: donnees_marche_eigen
#| echo: false
#| eval: true
#| message: false
round(eigen(V)$values,3)
```

6.  Quelle est l'inertie portée par l'axe de vecteur directeur
    $(1,0,0,0)^\top$ dans ce cas ?


7.  Que deviennent les matrices $V$ et $M$ dans ce cas ?


8.  Les valeurs propres de $M V M$ sont données ci-dessous. Quelle est
    maintenant la part d'inertie représentée sur le premier axe
    principal, sur le premier plan principal.

```{r}
#| label: donnees_marche_eigen_normed
#| echo: false
#| eval: true
#| message: false

M <- diag(1/sqrt(sum_dta$variance))
round(eigen(M%*%V%*%M)$values,3)
```


9.  On utilise le package `FactoMineR` pour réaliser l'ACP. Peut on
    deviner quelle est la métrique utilisée par défaut ? Quelles sont
    les variables bien représentées ? Discuter du lien entre les
    variables.

```{r}
#| label: donnees_marche_eigen_facto_var
#| echo: true
#| eval: true
#| message: false

walking_dta_pca <- PCA(walking_dta, graph = FALSE)
walking_dta_pca$eig
plot(walking_dta_pca, choix = "var")
```

10. En utilisant le graphique ci-dessous, que pouvez-vous dire

-   sur l'individu 10 ?
-   sur l'individu 94 ?

```{r}
#| label: donnees_marche_eigen_facto_ind
#| echo: true
#| eval: true
#| message: false

plot(walking_dta_pca, choix = "ind")
```

11. Quels sont les individus qui contribuent le plus à la formation du
    premier axe ?

```{r}
#| label: donnees_marche_eigen_facto_contrib
#| echo: true
#| eval: true
#| message: false

walking_dta_pca$ind$contrib |> as_tibble() |> rowid_to_column("Ind") |> arrange(-Dim.1)
```


```{r}
walking_dta_pca$ind$contrib |> as_tibble() |> rowid_to_column("Ind") |> arrange(-Dim.2)
```

12. Quels sont les individus les mieux représentés sur le premier axe ?

```{r}
#| label: donnees_marche_eigen_facto_cos2
#| echo: true
#| eval: true
#| message: false

walking_dta_pca$ind$cos2 |> as_tibble() |> rowid_to_column("Ind") |> arrange(-Dim.1)
```

13. Comment sont définies ces deux quantités ?

14. Comment mesurer la qualité de la représentation sur le premier plan
    ?


# Une première ACP. Etude des performance au Décathlon


La package `FactoMineR`contient un jeu de données sur des performances au Décathlon. Le tableau de données contient 41 lignes et 13 colonnes. Les dix premières colonnes correspondent aux performances des athlètes pour les dix épreuves du décathlon et les colonnes 11 et 12 correspondent respectivement au rang et au nombre de points obtenus. La dernière colonne indique la compétition durant laquelle a eu lieu cette performance  (Jeux Olympiques de 2004 ou Décastar 2004). Les lignes sont identifiés avec le nom de l'athlète.

Chargez la package FactoMineR et le tableau de données en tapant la ligne de code suivante :


```{r}
#| label: donnees_decathlon
#| echo: true
#| eval: true
#| message: false

library(FactoMineR)
data("decathlon")
```

1.  Discuter de la nature des variables



Le code ci-dessous calcule des résumés quantitatifs pour les variables
pertinentes.

```{r}
#| label: donnees_decathlon_sum
#| echo: true
#| eval: true
#| message: false

decathlon |> summarise(across(is.numeric, list(moyenne=mean, variance=var ))) |>
  pivot_longer(
    everything(),
    names_to = c("variable", ".value"),
    names_sep = "_"
  ) |>
   mutate(variance = variance *(n-1)/n) |> # pour corriger la variance par défaut de R
  mutate(across(is.numeric, \(x) round(x, 2)))
```

2.  Pour comprendre les relations entre les variables, nous pouvons
    réaliser une ACP.

-   Faut il prendre en compte toutes les variables quantitatives ?
-   Quelle choix de distance feriez vous ?

3.  l'ACP est réalisée grâce aux commandes suivantes. A quoi servent les
    options `quanti.sup` et `quali.sup` ? pourquoi ce choix ? Combien y
    a t il de variables quantitatives au total ?

```{r}
#| label: donnees_decathlon_pca
#| echo: true
#| eval: true
#| message: false
decathlon_pca <- PCA(decathlon, scale.unit = TRUE, quanti.sup = c("Rank"), quali.sup = "Competition", graph = FALSE, ncp = 11)
```

4.  Combien suggérez d'axes vous semble-t-il pertinent de regarder ?

```{r}
#| label: donnees_decathlon_eig
#| echo: true
#| eval: true
#| message: false
library(factoextra) # for nice vizualisation
decathlon_pca$eig
fviz_eig(decathlon_pca, choice = "eigenvalue", ncp = 11)
```

5.  Quelles sont les variables bien représentées sur le premier plan
    principal ?

```{r}
#| label: donnees_decathlon_var
#| echo: true
#| eval: true
#| message: false
library(factoextra) # for nice vizualisation
fviz_pca_var(decathlon_pca, axes = c(1,2), alpha.var = "cos2")
```

6.  Discuter du lien entre les variables. Cela semble-t-il surprenant ?

7.  Le saut à la perche `Pole.vault` est il bien représenté ? Sur quel
    plan faut-il projeté pour pouvoir visualiser les performances au
    saut à la perche ?

```{r}
#| label: donnees_decathlon_var_cos2
#| echo: true
#| eval: true
#| message: false
decathlon_pca$var$cos2
```

8.  Le saut à la perche est la huitième épreuve au décathlon, le javelot
    la neuvième, le 1500 m la dernière. Que laisse espérer une bonne
    performance au saut à la perche, quant à la performance au javelot à
    venir ?

```{r}
#| label: donnees_decathlon_var_34
#| echo: true
#| eval: true
#| message: false
fviz_pca_var(decathlon_pca, axes = c(3,4), alpha.var = "cos2")
```

9.  La variable nombre de points est très bien représentée par l'axe 1.
    que pensez de l'intérêt des trois dernières épreuves sur le résultat
    final ?

10. Ci-dessous le code pour obtenir la représentation des individus dans
    le premier plan principal. Citer un excellent décathlonien. Discuter
    de la performance de Casarsa (en haut à gauche) au 400m. Peut-on
    affirmer que Qi (près de l'origine) est un décathlonien moyen ?

```{r}
#| label: donnees_decathlon_ind12
#| echo: true
#| eval: true
#| message: false
fviz_pca_ind(decathlon_pca, axes = c(1,2), alpha.ind = "cos2")
```

11. Le graphique suivant ajoute l'information sur la Competition. Que
    pouvez vous déduire des résultats au Decastar et aux Jeux Olympiques
    ?



```{r}
#| label: donnees_decathlon_compare
#| echo: true
#| eval: true
#| message: false
plot.PCA(decathlon_pca,invisible=c('ind.sup'), habillage = c("Competition"),
         palette = c("#999999", "#222222"))
```

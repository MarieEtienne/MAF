---
title: "Lab4 - Explorer un jeu de données complexes"
author:
  - name: Marie-Pierre Etienne
    affiliation:
      - ENSAI - CREST
    email: marie-pierre.etienne@ensai.fr
date: last-modified
institute: https://marieetienne.github.io/MAF/
bibliography: TPs.bib
execute:
  echo: true
  eval: true
editor:
  markdown:
    wrap: 72
css: mpe_pres_revealjs.css
---


```{r setup, include=FALSE, eval = TRUE}

knitr::opts_chunk$set(comment = NA, cache = TRUE, message = FALSE,
                      warning = FALSE,
                      fig.align = "center")
library(tidyverse)
theme_set(theme_minimal())
library(wesanderson)
```

::: hidden
\$\$

\newcommand\R{{\mathbb{R}}}
\newcommand\Xbf{{\boldsymbol{X}}}
\newcommand\norm[1]{\lVert#1\rVert}
\newcommand\xcol[1]{\boldsymbol{x}^{#1}}
\newcommand\xrow[1]{\boldsymbol{x}_{#1}}
\newcommand\xbf{\boldsymbol{x}}
\newcommand\ybf{\boldsymbol{y}}

\$\$
:::

------------------------------------------------------------------------

# Présentation de la séance

L'objectif est de mettre en oeuvre les méthodes d'AFC et d'ACM pour explorer deux jeux de données dinnéerents. Le premier porte sur les logements, le second sur l'exploration de la richesse écologique de sites suivis.

# Typologie des logements

Nous souhaitons identifier les méthodes adéquates pour appréhender et
visualiser un jeu de données sur la consommation énergétiques des EPCI (
[Etablissements Publics de Coopération
Intercommunale](https://www.insee.fr/fr/metadonnees/definition/c1160) )
sur le territoire métropolitain en 2023.

## Présentation des données

Les données sont disponibles sur [ce
lien](https://raw.githubusercontent.com/MarieEtienne/MAF/refs/heads/master/logement_conso2023.csv)
Les variables disponibles dans ce jeu de données sont décrites ci dessous


Vous pouvez vous inspirer du code du précédent TP, disponible [ici](TP3_scriptR.html)

### Identification et informations géographiques

1.  **Id** : Identifiant unique pour chaque observation.
2.  **OPERATEUR** : Nom ou code de l'opérateur énergétique responsable.
3.  **Code.EPCI** : Code officiel de l'Établissement Public de
    Coopération Intercommunale (EPCI).
4.  **Nom.EPCI** : Nom de l'Établissement Public de Coopération
    Intercommunale.
5.  **Code.Département** : Code officiel du département.
6.  **Nom.Département** : Nom du département.
7.  **Code.Région** : Code officiel de la région.
8.  **Nom.Région** : Nom de la région.

### Consommation énergétique

9.  **Nb.sites** : Nombre total de sites ou de compteurs pris en compte
    dans l'analyse.
10. **Conso.totale..MWh.** : Consommation totale d'énergie, exprimée en
    mégawattheures (MWh), incluant tous les usages résidentiels.
11. **Conso.moyenne..MWh.** : Consommation moyenne d'énergie par site ou
    unité (exprimée en MWh) (Conso.totale..MWh./ Nb.sites).
12. **Part.thermosensible....** : Proportion (%) de la consommation
    totale attribuée à des usages thermosensibles (chauffage,
    climatisation).
13. **Conso.totale.à.usages.thermosensibles..MWh.** : Consommation
    totale spécifique aux usages thermosensibles (en MWh).
14. **Conso.totale.corrigée.de.l.aléa.climatique.à.usages.thermose** :
    Consommation totale pour des usages thermosensibles corrigée des
    aléas climatiques (en MWh).
15. **Conso.moyenne.à.usages.thermosensibles..MWh.** : Consommation
    moyenne pour des usages thermosensibles (en MWh).
16. **Conso.moyenne.corrigée.de.l.aléa.climatique.à.usages.thermos** :
    Consommation moyenne pour des usages thermosensibles, corrigée des
    variations climatiques (en MWh), la consommation attendue si les
    températures avaient été les températeures moyennes attendues.

### Caractéristiques socio-démographiques et du logement

17. **Nombre.d.habitants** : Nombre total d'habitants dans la région ou
    le territoire.
18. **Taux.de.logements.collectifs** : Proportion (%) de logements
    collectifs.
19. **Taux.de.résidences.principales** : Proportion (%) de résidences
    principales parmi tous les logements.
20. **Superficie.des.logements..30.m2** : Nombre de logements de moins
    de 30 m².
21. **Superficie.des.logements.30.à.40.m2** : Nombre de logements entre
    30 et 40 m².
22. **Superficie.des.logements.40.à.60.m2** : Nombre de logements entre
    40 et 60 m².
23. **Superficie.des.logements.60.à.80.m2** : Nombre de logements entre
    60 et 80 m².
24. **Superficie.des.logements.80.à.100.m2** : Nombre de logements entre
    80 et 100 m².
25. **Superficie.des.logements..100.m2** : Nombre de logements de plus
    de 100 m².

### Année de construction des résidences principales

26. **Résidences.principales.avant.1919** : Nombre de résidences
    principales construites avant 1919.
27. **Résidences.principales.de.1919.à.1945** : Nombre de résidences
    principales construites entre 1919 et 1945.
28. **Résidences.principales.de.1946.à.1970** : Nombre de résidences
    principales construites entre 1946 et 1970.
29. **Résidences.principales.de.1971.à.1990** : Nombre de résidences
    principales construites entre 1971 et 1990.
30. **Résidences.principales.de.1991.à.2005** : Nombre de résidences
    principales construites entre 1991 et 2005.
31. **Résidences.principales.de.2006.à.2015** : Nombre de résidences
    principales construites entre 2006 et 2015.
32. **Résidences.principales.après.2016** : Nombre de résidences
    principales construites après 2016.

### Modes de chauffage

33. **Taux.de.chauffage.électrique** : Proportion (%) de logements
    utilisant le chauffage électrique.

Sur une maille géographique donnée (EPCI), l’énergie annuelle totale
correspond au volume d’électricité consommée sur une année par
l’ensemble des sites (compteurs) pour le secteur résidentiel; l’énergie
annuelle moyenne correspond au volume d’électricité consommée sur une
année par l’ensemble des sites divisée par le nombre de sites.

Les données sont assemblées à partir du site
[data.gouv.fr](https://www.data.gouv.fr/fr/datasets/consommation-annuelle-delectricite-et-gaz-par-epci/#/resources)
et [l'Observatoire des
territoires](https://www.observatoire-des-territoires.gouv.fr/nombre-de-residences-principales).

Les définitions des modes de calcul sont disponibles sur le site
[d'ENEDIS](https://data.enedis.fr/api/v2/catalog/datasets/consommation-electrique-par-secteur-dactivite-epci/attachments/description_du_jeu_de_donnees_consommation_et_thermosensibilite_electriques_annuelles_pdf)

## Quelques remarques préalables

-   Les variables 20 à 25, donnent des effectifs par EPCI, ceci peut
    constituer une table de contingence, mais elles peuvent aussi être
    aggrégées à l'échelle du département pour construire des profils de
    département.

-   la même remarque peut être faite pour les variables 26 à 32.

-   On va travailler par département, certains EPCI sont à cheval sur
    plusieurs départements, il faut faire des choix les concernant.
    L'objectif du TP étant de mettre en oeuvre les méthodes vues en
    cours, nous allons opter pour un choix drastique et discutable,
    consistant à associer l'EPCI au département sur le lequel il a la
    plus grosse population.

## Les questions que l'on se pose

Ces données permmettent d'extraire des informations en rapport avec
différente question.

-   Peut on faire des typologies de département en terme d'habitat ?
-   Ces données permettent-elles de faire des hypothèses sur le lien
    entre type d'habitat et consommation ? ou entre vétusté du parc
    immobilier et consommation ?

## Mise en oeuvre

### Importation des données

```{r }
#| label: import_dta
#| eval: true


library(tidyverse)
library(FactoMineR)
library(factoextra)
library(janitor)# fonction clean_names
dta_logement_conso <- read.csv(file = "logement_conso2023.csv", header = TRUE)
```

1. Que fait la commande suivante

```{r}
#| label: clean_dta
#| eval: true

dta_logement_conso <- dta_logement_conso %>%
 clean_names() %>% ## clean variable names
  # gardez uniquement les colonnes utiles au TP (adaptez si besoin)
  select(
    id, operateur,
    code_epci, nom_epci,
    code_departement, nom_departement,
    code_region, nom_region,
    nb_sites, starts_with("conso"),
    nombre_d_habitants,
    taux_de_logements_collectifs,
    taux_de_residences_principales,
    starts_with("superficie_des_logements"),
    starts_with("residences_principales_"),
    taux_de_chauffage_electrique,
    part_thermosensible
  )
```

2. Combien y a t il de lignes au total ? Combien y a t il d'EPCI différents ?

### Vers Une typologie des départements

3. Expliquer le code suivant ligne à ligne

```{r}
#| label: affect_epci
#| eval: true

epci_unique_dta <- dta_logement_conso %>%
  group_by(code_epci) %>%
  slice_max(order_by = nombre_d_habitants, n = 1, with_ties = FALSE) %>%
  ungroup()
```


4. Combien y' a t il d'epci ?

```{r}
#| label: n_epci
#| eval: true

nrow(epci_unique_dta)
```

Le code suivant construit la table de contingence.

5. Expliquez le traitement différent des variables type superficie de logements et des variables taux de logement, notamment l'utilisation d'une moyenne pondérée.

```{r}
#| eval: true

dept <- epci_unique_dta %>%
  group_by(code_departement, nom_departement, nom_region) %>%
  summarise(
    # effectifs logement par classes de surface
    across(starts_with("superficie_des_logements"), ~ sum(.x, na.rm = TRUE)),
    # effectifs logement par périodes de construction
    across(starts_with("residences_principales_"), ~ sum(.x, na.rm = TRUE)),
    across(starts_with("conso_total"), ~ sum(.x, na.rm = TRUE)),
    conso_totale_m_wh = sum(conso_totale_m_wh, na.rm = TRUE),
    # moyenne pondérée par nb_sites (important !)
    conso_moyenne_m_wh = weighted.mean(conso_moyenne_m_wh, w = nb_sites, na.rm = TRUE),
    part_thermosensible = weighted.mean(part_thermosensible, w = nb_sites, na.rm = TRUE),
    taux_de_logements_collectifs = weighted.mean(taux_de_logements_collectifs, w = nb_sites, na.rm = TRUE),
    taux_de_chauffage_electrique = weighted.mean(taux_de_chauffage_electrique, w = nb_sites, na.rm = TRUE),
    nombre_d_habitants = sum(nombre_d_habitants, na.rm = TRUE),
    nb_sites = sum(nb_sites, na.rm = TRUE),
    .groups = "drop"
  )
```

### AFC sur les surfaces des logements

On se focalise pour le moment sur les données suivantes

```{r}
#| label: afc_surface
#| eval: true

tab_surface <- dept %>%
  select(code_departement, nom_departement, nom_region, starts_with("superficie_des_logements"), starts_with("taux"), starts_with("conso")) %>%
  column_to_rownames("nom_departement") |> select(-code_departement)

```

6. Réaliser un test ud chi-2 d'indépendance pour tester l'hypothèse d'indépandance entre le département et les surfaces de logements

7. On a vu dans le cours que la statistique de test du Chi-2 était liée à l'inertie calculée dans l'AFC. rappeler comment c'est lié et indiquer combien vaut $n$ dans ce cas ?

8 . Réaliser une AFC à l'aide de la fonction `CA`. Combien vaut l'inertie totale. Vérifier la cohérence avec votre réponse récédente


9. Quel est le nombre d'axes principaux maximal ? Combien d'axes vous semblent pertinents ?

10. Quels sont les types de logement  le plus contributif à l'axe 1 ? Quels sont les départements ? Quelle information représente l'axe 1 ?

11. Représenter sur le même graphique les lignes et les colonnes du tableau de contingence dont la qualité de représentation dépasse 0.8. Pour cela on peut s'aider de la structure suivante dans laquelle il faut juste précalculer les variables rows_keep et cols_keep


```{r}
#| label: biplot
#| echo: true
#| eval: false

fviz_ca_biplot(
  res_ca_surface,
  select.row = list(name = rows_keep),
  select.col = list(name = cols_keep),
  repel = TRUE
)

```

12. On souhaite faire le lien avec des éventuelles variables supplémentaires. Quel graphique proposez vous ? Quelle information pouvons-nous en tirer ? (Indication plot avec l'option choix = "quanti.sup").

# Typologie de sites écologiques

## Contexte

On s’intéresse à la **caractérisation et à la typologie de sites écologiques** décrits par des variables qualitatives liées au milieu, à la gestion et aux pressions anthropiques.

Chaque **individu statistique** correspond à un **site d’observation** (parcelle, zone naturelle, site suivi). Le jeu de données comporte **200 sites**.

L’objectif de l'analyse est

* d'explorer la structure des données qualitatives,
* d'identifier les **grands gradients écologiques**,


## Données

Le fichier [sites_acm.csv]((https://raw.githubusercontent.com/MarieEtienne/MAF/refs/heads/master/sites_acm.csv) contient les variables suivantes.

* **Milieu** : urbain / periurbain / rural
* **Couverture** : boise / prairial / agricole / mixte
* **Gestion** : fauche_tardive / fauche_frequente / paturage / aucune
* **Pression** : forte / moyenne / faible
* **Eau** : proche / eloigne
* **Artificialisation** : oui / non
* **Usage** : loisirs / agricole / conservation / mixte

On a également des informations sur
* **Richesse écologique** : faible / moyenne / elevee (classe de richesse spécifique)
* **Region** : Nord / Ouest / Sud / Est


## Description des données

1. Donner le nombre d’individus et de variables.

2. Dans l'objectif de faire une typologie des sites, préciser quelles variables vous souhaitez considérer comme actives et lesquelles seront supplémentaires.

3. Identifier des éventuelles modalités rares

 Aucune modalité n'est rare seule mais on s'attend à avoir des croisements peu fréquents dans la table de contingence par exemple artificialisation oui et gestion fauche_frequente..



## Construire une typologie des sites

### Mettre en place l'ACM

4. Que signifie ACM ?

5. Faire une ACM sur les données à l'aide de la fonction MCA, (prendre garde aux variables supplémentaires)

6. Présenter les **valeurs propres** et commenter la part d’inertie expliquée par les premiers axes.

## Donner du sens aux axes

Pour les deux premiers axes :

7. Identifier les **modalités les plus contributrices**.


8. Identifier les **modalités les mieux représentées** (cos² élevés).


### Visualisation

8. Représenter les **modalités** sur le plan factoriel (1,2). et discuter de leur organisation

9. Représenter les **individus**, colorés selon la variable *Milieu*.

### 5. Variables supplémentaires

10. Projeter les variables **Richesse** et **Region** sur le plan factoriel et commenter la position des différentes classes de richesse spécifique.

11. Discuter le rôle (ou l’absence de rôle) de la variable *Region* dans la structuration des données.
